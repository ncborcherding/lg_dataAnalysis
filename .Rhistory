load("./data/AA_combinations.rda")
out <- matrix(nrow = nrow(TCR), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- TCR$Var1
View(TCR)
vgenes <- unique(TCR[,1])
vgenes <- unique(TCR[,2])
vgenes <- unique(TCR[,4])
subset <- TCR[TCR$vgene %in% vgene[i],]
subset <- TCR[TCR$vgene %in% vgenes[i],]
View(subset)
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
out[1:5,1:5]
out[1:11,1:5]
out[1:12,1:5]
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[1:11,1:5]
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
View(positions_motif)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (i in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[i],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From)
df.edge <- rbind(df.edge, out)
}
positions_motif <- data.frame(df.edge, "Type" = "Motif")
positions_motif <- unique(positions_motif)
View(positions_motif)
q
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (i in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[i],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = motifs[i])
df.edge <- rbind(df.edge, out)
}
subset <- TCR[TCR$vgene %in% vgenes[i],]
i <- 1
j <- 1
subset <- TCR[TCR$vgene %in% vgenes[i],]
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (i in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[i],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = motifs[i])
df.edge <- rbind(df.edge, out)
}
View(df.edge)
View(positions_motif)
View(out)
df.edge <- NULL
for (i in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[i],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = colnames(out)[motifs[i]])
df.edge <- rbind(df.edge, out)
}
subset <- TCR[TCR$vgene %in% vgenes[i],]
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
j <- 1
subset <- TCR[TCR$vgene %in% vgenes[j],]
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (k in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[k],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = colnames(out)[motifs[k]])
df.edge <- rbind(df.edge, out)
}
correspond <- positions_motif[positions_motif[,2] == motifs[k],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = colnames(out)[motifs[k]])
out <- data.frame(To,From, spec.Motif = AA_combinations[motifs[k]])
df.edge <- rbind(df.edge, out)
localConvergence <- function(tmp, chain = "TCRB", motif.length = 3) {
load("./data/AA_combinations.rda")
TCR <- getTCR(tmp,chain)
positions <- NULL
vgenes <- unique(TCR[,4])
for (j in seq_along(vgenes)) {
subset <- TCR[TCR$vgene %in% vgenes[j],]
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (k in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[k],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = AA_combinations[motifs[k]])
df.edge <- rbind(df.edge, out)
}
positions <- rbind(positions, df.edge)
}
positions <- data.frame(positions, "Type" = "Motif")
positions<- unique(positions)
return(positions)
}
positions_motif <- localConvergence(tmp, chain = "TCRB", motif.length=3)
subset <- TCR[TCR$vgene %in% vgenes[j],]
out <- matrix(nrow = nrow(subset), ncol =length(AA_combinations), 0)
colnames(out) <- AA_combinations
rownames(out) <- subset$Var1
for (i in seq_len(nrow(subset))) {
tmp <- as.character(subset$Var1[i])
for (j in seq_len(nchar(tmp))) {
string <- substr(tmp, j, j+(motif.length-1))
if (string %in% AA_combinations & nchar(string) == motif.length) {
position <- which(colnames(out) == string)
out[i,position] <- out[i,position] + 1
} else {
next()
}
}
}
out[out == 0] <- NA
positions_motif <- getPostitions(out, 0,9)
motifs <- unique(positions_motif[,2])
df.edge <- NULL
for (k in seq_along(motifs)) {
correspond <- positions_motif[positions_motif[,2] == motifs[k],]
if (length(correspond) == 2) {
next()
}
out <- t(combn(c(correspond[,1], correspond[,1]), 2))
out <- unique(out)
out <- out[out[,1] != out[,2],]
To <- as.character(subset$Var1)[out[,1]]
From <- as.character(subset$Var1)[out[,2]]
out <- data.frame(To,From, spec.Motif = AA_combinations[motifs[k]])
df.edge <- rbind(df.edge, out)
}
positions <- rbind(positions, df.edge)
positions <- NULL
positions <- rbind(positions, df.edge)
View(positions)
source("./R/functions.R")
positions_motif <- localConvergence(tmp, chain = "TCRB", motif.length=3)
TCR <- getTCR(tmp,chain)
tmp <- combined[[15]]
positions_motif <- localConvergence(tmp, chain = "TCRB", motif.length=3)
View(positions_motif)
load("./data/pbmcControls.rda")
controls <- getTCR(pbmc, "TCRB")
sampleControl_gc <- function(i) {
con <- controls[sample(nrow(controls), nrow(TCR)),]
cdr3 <- chainCheck(chain)[[1]]
con2 <- pbmc[pbmc[,cdr3] %in% con$Var1,]
gc_con <- globalConvergence(con2, chain = "TCRB")
gc_con <- checkVgenes(gc_con, con)
y <- nrow(gc_con)
}
sampleControl_lc <- function(i) {
con <- controls[sample(nrow(controls), nrow(TCR)),]
cdr3 <- chainCheck(chain)[[1]]
con2 <- pbmc[pbmc[,cdr3] %in% con$Var1,]
lc_con <- localConvergence(con2, chain = "TCRB")
lc_con <- checkVgenes(gc_con, con)
y <- nrow(lc_con)
}
bootstrap_gc <- mclapply(1:1000, sampleControl_gc, mc.cores = 3)
library(pbmcapply)
bootstrap_gc <- pbmclapply(1:1000, sampleControl_gc, mc.cores = 3)
TCR <- getTCR(tmp, chain)
TCR_dist <- as.matrix(stringdistmatrix(TCR$Var1, method = "lv"))
TCR_dist[TCR_dist >= 2] <- NA
for (i in seq_len(ncol(TCR_dist))) {
TCR_dist[i,i] <- NA
}
positions_LV <- getPostitions(TCR_dist, 0,1, order = T)
source("./R/functions.R")
bootstrap_gc <- pbmclapply(1:1000, sampleControl_gc, mc.cores = 3)
sampleControl_lc <- function(i) {
con <- controls[sample(nrow(controls), nrow(TCR)),]
cdr3 <- chainCheck(chain)[[1]]
con2 <- pbmc[pbmc[,cdr3] %in% con$Var1,]
lc_con <- localConvergence(con2, chain = "TCRB")
y <- nrow(lc_con)
}
bootstrap_lc <- pbmclapply(1:10, sampleControl_lc, mc.cores = 3)
View(bootstrap_lc)
con <- controls[sample(nrow(controls), nrow(TCR)),]
cdr3 <- chainCheck(chain)[[1]]
con2 <- pbmc[pbmc[,cdr3] %in% con$Var1,]
lc_con <- localConvergence(con2, chain = "TCRB")
View(lc_con)
table(lc_con)
table(lc_con$spec.Motif)
unlist(table(lc_con$spec.Motif))
gc_con <- globalConvergence(con2, chain = "TCRB")
View(gc_con)
gc_con <- checkVgenes(gc_con, con)
View(gc_con)
TCR <- getTCR(tmp, chain)
TCR_dist <- as.matrix(stringdistmatrix(TCR$Var1, method = "lv"))
TCR_dist[TCR_dist >= 2] <- NA
for (i in seq_len(ncol(TCR_dist))) {
TCR_dist[i,i] <- NA
}
positions_LV <- getPostitions(TCR_dist, 0,1, order = T)
View(positions_LV)
colnames(positions_LV)[1:2] <- c("To", "From")
View(positions_LV)
positions_LV$To <- as.character(TCR$Var1)[positions_LV$To]
positions_LV$From <- as.character(TCR$Var1)[positions_LV$From]
positions_LV <- globalConvergence(tmp, chain = "TCRB")
positions_LV <- checkVgenes(positions_LV, TCR)
View(positions_LV)
bootstrap_gc <- pbmclapply(1:1000, sampleControl_gc, mc.cores = 3)
bootstrap_lc <- pbmclapply(1:10, sampleControl_lc, mc.cores = 3)
View(bootstrap_lc)
View(bootstrap_lc)
sampleControl_lc <- function(i) {
con <- controls[sample(nrow(controls), nrow(TCR)),]
cdr3 <- chainCheck(chain)[[1]]
con2 <- pbmc[pbmc[,cdr3] %in% con$Var1,]
lc_con <- localConvergence(con2, chain = "TCRB")
y <- unlist(table(lc_con$spec.Motif))
return(y)
}
bootstrap_lc <- pbmclapply(1:10, sampleControl_lc, mc.cores = 3)
View(bootstrap_lc)
bootstrap_lc <- pbmclapply(1:1000, sampleControl_lc, mc.cores = 3)
View(bootstrap_lc)
x <- bind_cols(bootstrap_lc)
View(bootstrap_lc)
merge(data.frame(bootstrap_lc[[1]], row.names=NULL), data.frame(bootstrap_lc[[2]], row.names=NULL), by = 0, all = TRUE)[-1]
merge(data.frame(bootstrap_lc[[1]], row.names=names(bootstrap_lc[[2]])), data.frame(bootstrap_lc[[2]], row.names=names(bootstrap_lc[[2]])), by = 0, all = TRUE)[-1]
data.frame(bootstrap_lc[[1]], row.names=names(bootstrap_lc[[2]]))
data.frame(bootstrap_lc[[1]])
do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names="Var1"), by = 0, all = TRUE))
merge(data.frame(bootstrap_lc[[1]], row.names="Var1"), data.frame(bootstrap_lc[[2]], row.names="Var1"), by = 0, all = TRUE)[-1]
x<- do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names="Var1"), by = "row.names", all = TRUE))
x<- do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names="Var1"), by = "Var1", all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame), by = "Var1", all = TRUE))
merge(data.frame(bootstrap_lc[[1]]), data.frame(bootstrap_lc[[2]]), by = "Var1", all = TRUE)[-1]
merge(data.frame(bootstrap_lc[[1]]), data.frame(bootstrap_lc[[2]]), by = "Var1", all = TRUE)
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame), by = "Var1", all = TRUE))
lapply(bootstrap_lc[[1:2]], data.frame)
lapply(bootstrap_lc, data.frame)
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame), by = "Var1"))
c(lapply(bootstrap_lc[[1]], data.frame)
)
x <- do.call("merge", lapply(bootstrap_lc, data.frame, by = "Var1", all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names = "Var1"), by = "Var1", all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names = "Var1"), by = 0, all = TRUE))
c(lapply(bootstrap_lc[[i]], data.frame, row.names = "Var1")
)
lapply(bootstrap_lc[[i]], data.frame, row.names = "Var1")
lapply(bootstrap_lc[[i]], data.frame(), row.names = "Var1")
lapply(bootstrap_lc[[i]], data.frame)
sapply(bootstrap_lc[[i]], data.frame)
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame, row.names = "Var1"), by = 0, all = TRUE))
x <- do.call("merge", c(lapply(data.frame(bootstrap_lc , row.names = "Var1")), by = 0, all = TRUE))
c(lapply(data.frame(bootstrap_lc[[x]] , row.names = "Var1")
)
)
test <- bootstrap_lc[[c(1,2)]]
test <- bootstrap_lc[[1:2]]
lapply(bootstrap_lc, data.frame)
View(bootstrap_gc)
x <- do.call("merge", c(lapply(bootstrap_lc, data.frame(x,row.names = "Var1")), by = 0, all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")}), by = 0, all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")}), by = "row.names", all = TRUE))
x <- do.call("merge", c(lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")}), by = "Var1", all = TRUE))
x <- do.call("merge", lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")}), by = "Var1", all = TRUE)
x <- lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")}), by = "Var1")
x <- lapply(bootstrap_lc, function(x){data.frame(x,row.names = "Var1")})
View(x)
View(x)
x[[1]]
x <- do.call("merge", x, by="row.names", all=TRUE)
View(x)
x <- lapply(bootstrap_lc, function(x){data.frame(x)})
View(x)
x <- do.call("merge", x, by="Var1", all=TRUE)
x <- lapply(x, function(x){merge(by="Var1", all=TRUE)})
x <- lapply(x, function(y){merge(y,by="Var1", all=TRUE)})
y <- do.call("merge", x, , by = "Var1", all = TRUE)
y <- do.call("merge", x, by = "Var1", all = TRUE)
View(x)
merged.data.frame = Reduce(function(...) merge(..., all=T), x)
View(merged.data.frame)
merged.data.frame <- reshape::merge_all(x, by = "Var1")
df <- Reduce(function(x, y) merge(x=x, y=y, by="Var1", all.x=T, all.y=T), x)
View(df)
df[is.na(df)] <- 0
table <- table(positions_motif)
positions_motif <- checkVgenes(positions_motif, TCR)
table <- table(positions_motif)
table <- table(positions_motif$spec.Motif)
head(table)
table <- table(positions_motif$spec.Motif)
table <- as.data.frame(table(positions_motif$spec.Motif))
View(table)
table <- as.data.frame(table(positions_motif$spec.Motif))
View(table)
View(table)
i <- 1
vector <- df[table[,Var1][i], ]
vector <- df[table[,"Var1"][i], ]
View(vector)
vector <- df[table[,"Var1"][i], 2:ncol(df)]
number <- table[i,"Freq"]
p <- vectr[vector >= number]/length(vector)
p <- length(vector[vector >= number])/length(vector)
number
vector[1:10]
View(table)
for (i in seq_len(nrow(table))) {
vector <- df[table[,"Var1"][i], 2:ncol(df)]
number <- table[i,"Freq"]
table$p[i] <- length(vector[vector >= number])/length(vector)
}
View(table)
vector <- df[table[,"Var1"][2], 2:ncol(df)]
View(vector)
table[table$p <= 0.001]
table[table$p <= 0.001,]
table <- table[table$p <= 0.001,]
positions_motif[positions_motif$spec.Motif %in% table$Var1,]
positions_motif <- positions_motif[positions_motif$spec.Motif %in% table$Var1,]
library(ggraph)
library(igraph)
edges <- rbind.data.frame(positions_LV, positions_motif)
View(positions_motif)
edges <- rbind.data.frame(positions_LV, positions_motif[,c(1,2,4)])
edges <- checkVgenes(edges, TCR)
vertices <- as.data.frame(TCR$Var1)
g = graph_from_data_frame(edges, directed = TRUE, vertices = vertices)
ggraph(g) +
geom_edge_link(show.legend = FALSE, aes(color = "Type")) +
geom_node_point()  +
theme_graph()
table <- as.data.frame(table(positions_motif$spec.Motif))
for (i in seq_len(nrow(table))) {
vector <- df[table[,"Var1"][i], 2:ncol(df)]
number <- table[i,"Freq"]
table$p[i] <- length(vector[vector >= number])/length(vector)
table$fc[i] <- number/median(vector)
}
for (i in seq_len(nrow(table))) {
vector <- df[table[,"Var1"][i], 2:ncol(df)]
number <- table[i,"Freq"]
table$p[i] <- length(vector[vector >= number])/length(vector)
table$fc[i] <- number/median(as.numeric(vector))
}
table <- as.data.frame(table(positions_motif$spec.Motif))
View(table)
positions_motif <- localConvergence(tmp, chain = "TCRB", motif.length=3)
library(stringr)
library(stringdist)
library(parallel)
library(pbmcapply)
positions_motif <- localConvergence(tmp, chain = "TCRB", motif.length=3)
positions_motif <- checkVgenes(positions_motif, TCR)
table <- as.data.frame(table(positions_motif$spec.Motif))
for (i in seq_len(nrow(table))) {
vector <- df[table[,"Var1"][i], 2:ncol(df)]
number <- table[i,"Freq"]
table$p[i] <- length(vector[vector >= number])/length(vector)
table$fc[i] <- number/median(as.numeric(vector))
}
View(table)
Inf > 2
table <- table[table$p <= 0.001 & table$fc > 5,]
positions_motif <- positions_motif[positions_motif$spec.Motif %in% table$Var1,]
edges <- rbind.data.frame(positions_LV, positions_motif[,c(1,2,4)])
edges <- checkVgenes(edges, TCR)
vertices <- as.data.frame(TCR$Var1)
g = graph_from_data_frame(edges, directed = TRUE, vertices = vertices)
ggraph(g) +
geom_edge_link(show.legend = FALSE, aes(color = "Type")) +
geom_node_point()  +
theme_graph()
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
library(BiocStyle)
suppressMessages(library(scRepertoire))
